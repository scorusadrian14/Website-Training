# ===================== USER SETTINGS =====================
$pptxPath = "D:\AScorus\Moodle-Cursuri\AB004\AB-004.pptx"
$outDir   = "D:\AScorus\Screenshots"
$delayMs  = 700          # render delay per slide
# =========================================================

Set-StrictMode -Version Latest
$ErrorActionPreference = "Stop"

# Office MsoTriState values
$msoTrue  = -1
$msoFalse = 0

Add-Type -AssemblyName System.Drawing
Add-Type -AssemblyName System.Windows.Forms

# Win32 helpers (find slideshow window + focus it)
Add-Type -TypeDefinition @"
using System;
using System.Runtime.InteropServices;
using System.Text;

public static class Win32 {
    [DllImport("user32.dll", SetLastError=true)]
    public static extern IntPtr FindWindow(string lpClassName, string lpWindowName);

    [DllImport("user32.dll")]
    public static extern bool SetForegroundWindow(IntPtr hWnd);

    [DllImport("user32.dll")]
    public static extern bool ShowWindow(IntPtr hWnd, int nCmdShow);
}
"@

function Capture-Region {
    param(
        [int]$left,
        [int]$top,
        [int]$width,
        [int]$height,
        [string]$file
    )

    if ($width -le 0 -or $height -le 0) {
        throw "Invalid capture size: ${width}x${height}"
    }

    $bmp = New-Object System.Drawing.Bitmap $width, $height
    $gfx = [System.Drawing.Graphics]::FromImage($bmp)
    try {
        $gfx.CopyFromScreen($left, $top, 0, 0, $bmp.Size)
        $bmp.Save($file, [System.Drawing.Imaging.ImageFormat]::Png)
    }
    finally {
        $gfx.Dispose()
        $bmp.Dispose()
    }
}

function Focus-Slideshow {
    param(
        [int]$retryMs = 2000
    )
    # PowerPoint slideshow window class is commonly "screenClass"
    # We retry for a short period because the window appears after Run()
    $swRestore = 9
    $elapsed = 0

    while ($elapsed -lt $retryMs) {
        $hWnd = [Win32]::FindWindow("screenClass", $null)
        if ($hWnd -ne [IntPtr]::Zero) {
            [Win32]::ShowWindow($hWnd, $swRestore) | Out-Null
            [Win32]::SetForegroundWindow($hWnd) | Out-Null
            Start-Sleep -Milliseconds 150
            return $hWnd
        }
        Start-Sleep -Milliseconds 100
        $elapsed += 100
    }

    return [IntPtr]::Zero
}

# --- Validate / prepare ---
if (-not (Test-Path -LiteralPath $pptxPath)) { throw "File not found: $pptxPath" }
New-Item -ItemType Directory -Force -Path $outDir | Out-Null

$ppt  = $null
$pres = $null
$ssw  = $null

try {
    # Start PowerPoint
    $ppt = New-Object -ComObject PowerPoint.Application
    $ppt.Visible = $msoTrue

    # Open presentation: Open(FileName, ReadOnly, Untitled, WithWindow)
    $pres = $ppt.Presentations.Open($pptxPath, $msoTrue, $msoFalse, $msoTrue)

    # Start full-screen slideshow
    $settings = $pres.SlideShowSettings
    $settings.StartingSlide = 1
    $settings.EndingSlide   = $pres.Slides.Count
    $settings.Run() | Out-Null

    Start-Sleep -Milliseconds 800

    # Get slideshow window object (for Left/Top/Width/Height and navigation)
    $ssw = $ppt.SlideShowWindows.Item(1)

    # Force slideshow window to foreground (prevents capturing the PowerShell window)
    $hShow = Focus-Slideshow -retryMs 2500
    if ($hShow -eq [IntPtr]::Zero) {
        throw "Could not find the slideshow window (class 'screenClass'). The slideshow may be in Presenter View or blocked by policy."
    }

    $total = $pres.Slides.Count

    for ($i = 1; $i -le $total; $i++) {
        # Keep it focused in case something steals focus
        [Win32]::SetForegroundWindow($hShow) | Out-Null

        Start-Sleep -Milliseconds $delayMs

        $file = Join-Path $outDir ("slide {0}.png" -f $i)

        # Capture the slideshow region
        Capture-Region ([int]$ssw.Left) ([int]$ssw.Top) ([int]$ssw.Width) ([int]$ssw.Height) $file

        if ($i -lt $total) {
            $ssw.View.Next()
        }
    }

    $ssw.View.Exit()

    "Done. Saved $total screenshots to: $outDir"
}
finally {
    # Clean up
    try { if ($pres -ne $null) { $pres.Close() | Out-Null } } catch {}
    try { if ($ppt  -ne $null) { $ppt.Quit()  | Out-Null } } catch {}

    try { if ($ssw  -ne $null) { [void][System.Runtime.InteropServices.Marshal]::ReleaseComObject($ssw) } } catch {}
    try { if ($pres -ne $null) { [void][System.Runtime.InteropServices.Marshal]::ReleaseComObject($pres) } } catch {}
    try { if ($ppt  -ne $null) { [void][System.Runtime.InteropServices.Marshal]::ReleaseComObject($ppt) } } catch {}

    [GC]::Collect()
    [GC]::WaitForPendingFinalizers()
}